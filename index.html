<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Job Portal</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { margin:0; font-family: Arial, sans-serif; background-size: cover; background-position: center; transition: background 0.5s; }
  .card-container { display: grid; place-items: center; min-height: 100vh; padding: 20px; }
  .custom-card { background: rgba(255,255,255,0.95); border-radius: 15px; padding:20px; width: 100%; max-width: 600px; box-shadow:0 4px 20px rgba(0,0,0,0.1); animation: slideUp 0.8s ease-out; }
  @keyframes slideUp { from{opacity:0;transform:translateY(40px);} to{opacity:1; transform:translateY(0);} }
  .hidden { display:none; }
  .bg-login { background-image:url('images/login-bg.jpg'); }
  .bg-register { background-image:url('images/register-bg.jpg'); }
  .bg-applicant { background-image:url('images/applicant-bg.jpg'); }
  .bg-hr { background-image:url('images/hr-bg.jpg'); }
</style>
</head>
<body class="bg-login">

<!-- Login -->
<section id="loginPage" class="card-container">
  <div class="custom-card">
    <h2 class="text-center">Login</h2>
    <form id="loginForm">
      <div class="mb-3"><label>Email</label><input type="email" class="form-control" id="loginEmail" required></div>
      <div class="mb-3"><label>Password</label><input type="password" class="form-control" id="loginPassword" required></div>
      <div class="mb-3">
        <label>Role</label>
        <select id="loginRole" class="form-control" required>
          <option value="applicant">Applicant</option>
          <option value="hr">HR</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary w-100">Login</button>
      <p class="mt-3 text-center">Donâ€™t have an account? <a href="#" id="goRegister">Register</a></p>
    </form>
  </div>
</section>

<!-- Register -->
<section id="registerPage" class="card-container hidden">
  <div class="custom-card">
    <h2 class="text-center">Register</h2>
    <form id="registerForm" enctype="multipart/form-data">
      <div class="mb-3"><label>Role</label>
        <select id="regRole" class="form-control" required>
          <option value="applicant">Applicant</option>
          <option value="hr">HR</option>
        </select>
      </div>

      <!-- Common -->
      <div class="mb-3"><label>Name</label><input type="text" id="regName" class="form-control" required></div>
      <div class="mb-3"><label>Email</label><input type="email" id="regEmail" class="form-control" required></div>
      <div class="mb-3"><label>Password</label><input type="password" id="regPassword" class="form-control" required></div>
      <div class="mb-3"><label>Age</label><input type="number" id="regAge" class="form-control" required></div>
      <div class="mb-3"><label>Phone</label><input type="text" id="regPhone" class="form-control" required></div>
      <div class="mb-3"><label>Photo</label><input type="file" id="regPhoto" class="form-control"></div>

      <!-- Applicant fields -->
      <div id="applicantFields" class="hidden">
        <div class="mb-3"><label>Gender</label><input type="text" id="regGender" class="form-control"></div>
        <div class="mb-3"><label>Education</label><input type="text" id="regEducation" class="form-control"></div>
        <div class="mb-3"><label>Specialization</label><input type="text" id="regSpecialization" class="form-control"></div>
        <div class="mb-3"><label>University</label><input type="text" id="regUniversity" class="form-control"></div>
        <div class="mb-3"><label>Year</label><input type="number" id="regYear" class="form-control"></div>
        <div class="mb-3"><label>Skills (comma separated)</label><input type="text" id="regSkills" class="form-control"></div>
        <div class="mb-3"><label>Experience (years)</label><input type="number" id="regExperience" class="form-control"></div>
        <div class="mb-3"><label>Resume</label><input type="file" id="regResume" class="form-control"></div>
      </div>

      <!-- HR fields -->
      <div id="hrFields" class="hidden">
        <div class="mb-3"><label>Company</label><input type="text" id="regCompany" class="form-control"></div>
        <div class="mb-3"><label>Designation</label><input type="text" id="regDesignation" class="form-control"></div>
        <div class="mb-3"><label>Industry</label><input type="text" id="regIndustry" class="form-control"></div>
        <div class="mb-3"><label>Address</label><input type="text" id="regAddress" class="form-control"></div>
      </div>

      <button type="submit" class="btn btn-success w-100">Register</button>
      <p class="mt-3 text-center">Already have an account? <a href="#" id="goLogin">Login</a></p>
    </form>
  </div>
</section>

<!-- Applicant Dashboard -->
<section id="applicantDashboard" class="card-container hidden">
  <div class="custom-card" style="max-width:800px;">
    <h2 class="text-center">Applicant Dashboard</h2>
    <button class="btn btn-danger w-100 mb-3" id="logoutApplicant">Logout</button>

    <h4>Available Jobs</h4>
    <div id="jobList"></div>

    <h4 class="mt-3">Applied Jobs</h4>
    <div id="appliedList"></div>

    <h4 class="mt-3">Messages</h4>
    <div id="msgList"></div>
  </div>
</section>

<!-- HR Dashboard -->
<section id="hrDashboard" class="card-container hidden">
  <div class="custom-card" style="max-width:800px;">
    <h2 class="text-center">HR Dashboard</h2>
    <button class="btn btn-danger w-100 mb-3" id="logoutHR">Logout</button>

    <h4>Post Job</h4>
    <form id="postJobForm">
      <div class="mb-2"><label>Title</label><input type="text" id="jobTitle" class="form-control" required></div>
      <div class="mb-2"><label>Description</label><input type="text" id="jobDesc" class="form-control" required></div>
      <div class="mb-2"><label>Location</label><input type="text" id="jobLoc" class="form-control" required></div>
      <div class="mb-2"><label>Salary</label><input type="text" id="jobSalary" class="form-control" required></div>
      <div class="mb-2"><label>Skills required (comma separated)</label><input type="text" id="jobSkills" class="form-control" required></div>
      <div class="mb-2"><label>Experience Required</label><input type="number" id="jobExp" class="form-control" required></div>
      <div class="mb-2"><label>End Date (YYYY-MM-DD)</label><input type="date" id="jobEnd" class="form-control" required></div>
      <button type="submit" class="btn btn-primary w-100 mt-2">Post Job</button>
    </form>

    <h4 class="mt-3">Your Jobs</h4>
    <div id="hrJobs"></div>
  </div>
</section>

<script>
const backendURL = "https://backend-ats-z0tb.onrender.com"; // Replace with your Render backend URL

// Page switching
function showPage(page, bgClass){
  document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
  document.getElementById(page).classList.remove("hidden");
  document.body.className = bgClass;
}

// Login/Register toggle
document.getElementById("goRegister").addEventListener("click", ()=>showPage("registerPage","bg-register"));
document.getElementById("goLogin").addEventListener("click", ()=>showPage("loginPage","bg-login"));

// Show fields based on role in registration
document.getElementById("regRole").addEventListener("change", e=>{
  if(e.target.value=="applicant"){
    document.getElementById("applicantFields").classList.remove("hidden");
    document.getElementById("hrFields").classList.add("hidden");
  }else{
    document.getElementById("hrFields").classList.remove("hidden");
    document.getElementById("applicantFields").classList.add("hidden");
  }
});

// ----------- Login -----------
document.getElementById("loginForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  const role = document.getElementById("loginRole").value;

  try{
    const res = await fetch(`${backendURL}/${role}/login`,{
      method:"POST",
      body: new URLSearchParams({email,password})
    });
    const data = await res.json();
    if(res.ok){
      sessionStorage.setItem("user", JSON.stringify(data[role] || data.applicant));
      if(role=="applicant") showApplicantDashboard();
      else showHRDashboard();
    }else alert(data.detail);
  }catch(err){console.log(err);}
});

// ----------- Register -----------
document.getElementById("registerForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const role = document.getElementById("regRole").value;
  const formData = new FormData();
  formData.append("name", document.getElementById("regName").value);
  formData.append("email", document.getElementById("regEmail").value);
  formData.append("password", document.getElementById("regPassword").value);
  formData.append("age", document.getElementById("regAge").value);
  formData.append("phone", document.getElementById("regPhone").value);
  formData.append("photo", document.getElementById("regPhoto").files[0]||null);

  if(role=="applicant"){
    formData.append("gender", document.getElementById("regGender").value);
    formData.append("education", document.getElementById("regEducation").value);
    formData.append("specialization", document.getElementById("regSpecialization").value);
    formData.append("university", document.getElementById("regUniversity").value);
    formData.append("year", document.getElementById("regYear").value);
    formData.append("skills", document.getElementById("regSkills").value);
    formData.append("experience", document.getElementById("regExperience").value);
    formData.append("resume", document.getElementById("regResume").files[0]||null);
  }else{
    formData.append("company", document.getElementById("regCompany").value);
    formData.append("designation", document.getElementById("regDesignation").value);
    formData.append("industry", document.getElementById("regIndustry").value);
    formData.append("address", document.getElementById("regAddress").value);
  }

  try{
    const res = await fetch(`${backendURL}/${role}/register`,{method:"POST", body:formData});
    const data = await res.json();
    if(res.ok) { alert("Registered successfully"); showPage("loginPage","bg-login"); }
    else alert(data.detail);
  }catch(err){console.log(err);}
});

// ----------- Dashboards -----------
function showApplicantDashboard(){
  showPage("applicantDashboard","bg-applicant");
  loadJobs();
  loadAppliedJobs();
  loadMessages();
}

function showHRDashboard(){
  showPage("hrDashboard","bg-hr");
  loadHRJobs();
}

// Logout
document.getElementById("logoutApplicant").addEventListener("click", ()=>{
  sessionStorage.clear();
  showPage("loginPage","bg-login");
});
document.getElementById("logoutHR").addEventListener("click", ()=>{
  sessionStorage.clear();
  showPage("loginPage","bg-login");
});

// ---------- Applicant Functions ----------
async function loadJobs(){
  const res = await fetch(`${backendURL}/jobs`);
  const data = await res.json();
  const jobList = document.getElementById("jobList");
  jobList.innerHTML = "";
  data.jobs.forEach(job=>{
    const div = document.createElement("div");
    div.className="border p-2 my-2";
    div.innerHTML = `<b>${job.title}</b> - ${job.location} <br>Skills: ${job.skills_required.join(", ")}<br>Exp: ${job.experience_required} years<br><button class="btn btn-sm btn-success mt-1" onclick="applyJob('${job.id}')">Apply</button>`;
    jobList.appendChild(div);
  });
}

async function applyJob(job_id){
  const email = JSON.parse(sessionStorage.getItem("user")).email;
  const res = await fetch(`${backendURL}/apply-job`,{
    method:"POST",
    body: new URLSearchParams({applicant_email:email, job_id})
  });
  const data = await res.json();
  alert(data.message || data.error);
  loadAppliedJobs();
}

async function loadAppliedJobs(){
  const email = JSON.parse(sessionStorage.getItem("user")).email;
  const res = await fetch(`${backendURL}/applicant/applied-jobs/${email}`);
  const data = await res.json();
  const list = document.getElementById("appliedList");
  list.innerHTML="";
  data.applied_jobs.forEach(job=>{
    const div = document.createElement("div");
    div.className="border p-2 my-2";
    div.innerHTML = `<b>${job.title}</b> - Status: ${job.status}`;
    list.appendChild(div);
  });
}

async function loadMessages(){
  const email = JSON.parse(sessionStorage.getItem("user")).email;
  const res = await fetch(`${backendURL}/applicant/messages/${email}`);
  const data = await res.json();
  const list = document.getElementById("msgList");
  list.innerHTML="";
  data.messages.forEach(msg=>{
    const div = document.createElement("div");
    div.className="border p-2 my-2";
    div.innerHTML=`<b>From: ${msg.from}</b><br>${msg.message}`;
    list.appendChild(div);
  });
}

// ---------- HR Functions ----------
document.getElementById("postJobForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const hr = JSON.parse(sessionStorage.getItem("user")).email;
  const res = await fetch(`${backendURL}/hr/post-job`,{
    method:"POST",
    body: new URLSearchParams({
      hr_email: hr,
      title: document.getElementById("jobTitle").value,
      description: document.getElementById("jobDesc").value,
      location: document.getElementById("jobLoc").value,
      salary: document.getElementById("jobSalary").value,
      skills_required: document.getElementById("jobSkills").value,
      experience_required: document.getElementById("jobExp").value,
      end_date: document.getElementById("jobEnd").value
    })
  });
  const data = await res.json();
  alert(data.message);
  loadHRJobs();
});

async function loadHRJobs(){
  const hrEmail = JSON.parse(sessionStorage.getItem("user")).email;
  const res = await fetch(`${backendURL}/jobs`);
  const data = await res.json();
  const hrJobs = document.getElementById("hrJobs");
  hrJobs.innerHTML="";
  data.jobs.filter(j=>j.posted_by==hrEmail).forEach(job=>{
    const div = document.createElement("div");
    div.className="border p-2 my-2";
    div.innerHTML=`<b>${job.title}</b> - ${job.location}<br>Exp: ${job.experience_required}<br>
    <button class="btn btn-sm btn-primary mt-1" onclick="viewApplications('${job.id}')">View Applications</button>`;
    hrJobs.appendChild(div);
  });
}

async function viewApplications(job_id){
  const res = await fetch(`${backendURL}/applications/${job_id}`);
  const data = await res.json();
  let html = "";
  data.applications.forEach(app=>{
    html+=`<div class="border p-2 my-2">
    <b>${app.applicant_email}</b> - Status: ${app.status} <br>
    <button onclick="updateStatus('${job_id}','${app.applicant_email}','Shortlisted')">Shortlist</button>
    <button onclick="updateStatus('${job_id}','${app.applicant_email}','Rejected')">Reject</button>
    <button onclick="sendMsg('${job_id}','${app.applicant_email}')">Message</button>
    </div>`;
  });
  alert(html); // simple popup, can be replaced with modal
}

async function updateStatus(job_id,email,status){
  const res = await fetch(`${backendURL}/hr/update-status`,{
    method:"POST",
    body: new URLSearchParams({job_id, applicant_email: email, status})
  });
  const data = await res.json();
  alert(data.message);
  loadHRJobs();
}

function sendMsg(job_id,email){
  const hr = JSON.parse(sessionStorage.getItem("user")).email;
  const msg = prompt("Enter message:");
  if(msg){
    fetch(`${backendURL}/hr/message`,{
      method:"POST",
      body: new URLSearchParams({job_id, applicant_email:email, hr_email:hr, message:msg})
    }).then(r=>r.json()).then(d=>{alert(d.message);});
  }
}
</script>

</body>
</html>
